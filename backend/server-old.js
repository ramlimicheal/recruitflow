const express = require('express');\nconst cors = require('cors');\nconst dotenv = require('dotenv');\nconst http = require('http');\nconst socketIo = require('socket.io');\nconst path = require('path');\n\ndotenv.config();\n\nconst app = express();\nconst server = http.createServer(app);\nconst io = socketIo(server, {\n  cors: {\n    origin: process.env.FRONTEND_URL || 'http://localhost:5173',\n    methods: ['GET', 'POST'],\n    credentials: true\n  }\n});\n\n// Middleware\napp.use(cors());\napp.use(express.json());\napp.use(express.urlencoded({ extended: true }));\n\n// Import routes\nconst authRoutes = require('./routes/auth');\nconst candidateRoutes = require('./routes/candidates');\nconst taskRoutes = require('./routes/tasks');\nconst chatRoutes = require('./routes/chat');\nconst notificationRoutes = require('./routes/notifications');\nconst activityRoutes = require('./routes/activities');\nconst userRoutes = require('./routes/users');\n\n// Use routes\napp.use('/api/auth', authRoutes);\napp.use('/api/candidates', candidateRoutes);\napp.use('/api/tasks', taskRoutes);\napp.use('/api/chat', chatRoutes);\napp.use('/api/notifications', notificationRoutes);\napp.use('/api/activities', activityRoutes);\napp.use('/api/users', userRoutes);\n\n// Health check\napp.get('/api/health', (req, res) => {\n  res.json({ status: 'Backend is running', timestamp: new Date() });\n});\n\n// Socket.io event handlers\nconst connectedUsers = new Map();\n\nio.on('connection', (socket) => {\n  console.log(`User connected: ${socket.id}`);\n  \n  // Track connected users\n  socket.on('user-online', (userId) => {\n    connectedUsers.set(userId, socket.id);\n    console.log(`User ${userId} marked online`);\n  });\n\n  // Chat message events\n  socket.on('send-message', (messageData) => {\n    console.log('Message received:', messageData);\n    // Broadcast to relevant channel\n    io.emit('message-received', messageData);\n  });\n\n  // Notification events\n  socket.on('send-notification', (notificationData) => {\n    console.log('Notification sent:', notificationData);\n    // Notify specific users\n    if (notificationData.userId) {\n      const userSocket = connectedUsers.get(notificationData.userId);\n      if (userSocket) {\n        io.to(userSocket).emit('notification-received', notificationData);\n      }\n    } else {\n      io.emit('notification-received', notificationData);\n    }\n  });\n\n  // Activity feed events\n  socket.on('activity-log', (activityData) => {\n    console.log('Activity logged:', activityData);\n    io.emit('activity-created', activityData);\n  });\n\n  // Stage change events\n  socket.on('candidate-stage-changed', (stageData) => {\n    console.log('Candidate stage changed:', stageData);\n    io.emit('stage-updated', stageData);\n  });\n\n  socket.on('disconnect', () => {\n    console.log(`User disconnected: ${socket.id}`);\n    // Remove user from connected map\n    for (let [userId, socketId] of connectedUsers) {\n      if (socketId === socket.id) {\n        connectedUsers.delete(userId);\n        break;\n      }\n    }\n  });\n});\n\n// Pass io to routes\napp.use((req, res, next) => {\n  req.io = io;\n  req.connectedUsers = connectedUsers;\n  next();\n});\n\nconst PORT = process.env.PORT || 5000;\n\nserver.listen(PORT, () => {\n  console.log(`Server running on port ${PORT}`);\n  console.log(`Frontend URL: ${process.env.FRONTEND_URL || 'http://localhost:5173'}`);\n});\n\nmodule.exports = { app, io, server };\n"